# Browser Automation Best Practices

## Overview
This document provides critical guidelines for using the built-in browser automation tools effectively. Following these practices will prevent common errors and ensure reliable browser testing.

## The Golden Rule: Always Snapshot First

**ALWAYS run `browser_snapshot` before attempting any interaction.** This is the #1 most common mistake.

```typescript
// ✅ CORRECT - Snapshot first, then interact
1. browser_snapshot()
2. Look at the snapshot results to find the correct ref
3. Use that ref in browser_click, browser_type, etc.

// ❌ WRONG - Trying to interact without snapshot
browser_click({ ref: "[data-testid='theme-selector']", element: "theme selector" })
// This will often fail because you don't have the correct ref from the snapshot
```

## Understanding Refs vs Selectors

### What is a `ref`?
- The `ref` parameter comes FROM the snapshot output
- It's a unique identifier generated by the browser snapshot tool
- It's NOT a CSS selector you make up
- It's NOT a data attribute from your code

### What is the `element` parameter?
- A human-readable description for permission purposes
- Helps the user understand what you're trying to click
- NOT used for actually finding the element

## Common Selector Mistakes

### ❌ Invalid Pseudo-Selectors
```typescript
// WRONG - hastext() doesn't exist in CSS
browser_click({
  ref: '[data-cursor-ref="button:hastext(\\"Set Dark Theme\\")"]',
  element: "Dark theme button"
})

// WRONG - These pseudo-selectors don't exist
ref: "button:hastext('Submit')"
ref: "div:contains('Welcome')"
ref: "a:withtext('Click here')"
```

### ❌ Making Up Data Attributes
```typescript
// WRONG - data-cursor-ref doesn't exist in your code
ref: '[data-cursor-ref="theme-selector"]'

// Check your actual component code to see what attributes exist
// In this case, the component has: data-testid="theme-selector"
```

### ✅ Correct Approach
```typescript
// Step 1: Snapshot
browser_snapshot()

// Step 2: Look at the snapshot output, find something like:
// "select#theme-selector" or "[data-testid='theme-selector']" with a ref ID

// Step 3: Use the EXACT ref from the snapshot
browser_click({
  ref: "1234", // The actual ref from snapshot (usually a number or simple ID)
  element: "theme selector dropdown"
})
```

## Valid CSS Selectors (When You Must Use Them)

If you absolutely need to construct a selector without a snapshot (NOT recommended), use only valid CSS:

### ✅ Valid CSS Selectors
```css
/* Element selectors */
button
select
input

/* Class selectors */
.theme-selector
.btn-primary

/* ID selectors */
#theme-selector

/* Attribute selectors */
[data-testid="theme-selector"]
[aria-label="Select theme"]
[type="submit"]

/* Combinators */
div > button
.container button
button + button

/* Pseudo-classes (standard CSS only) */
button:hover
input:focus
select:first-child
div:nth-child(2)
```

### ❌ Invalid Pseudo-Selectors
```css
/* These DO NOT exist in standard CSS querySelector */
button:hastext("Click me")
div:contains("Welcome")
a:withtext("Link")
element:hasclass("active")
```

## Working with Different Element Types

### Dropdowns/Select Elements
```typescript
// 1. Snapshot first
browser_snapshot()

// 2. Find the select element in the snapshot, get its ref
// 3. Use browser_select_option
browser_select_option({
  ref: "ref-from-snapshot",
  element: "theme selector",
  values: ["dark"]
})
```

### Buttons
```typescript
// 1. Snapshot first
browser_snapshot()

// 2. Find button in snapshot by looking for:
//    - data-testid attribute
//    - button text content
//    - aria-label
// 3. Click using the ref from snapshot
browser_click({
  ref: "ref-from-snapshot", 
  element: "submit button"
})
```

### Text Inputs
```typescript
// 1. Snapshot
browser_snapshot()

// 2. Find input, get ref
// 3. Type into it
browser_type({
  ref: "ref-from-snapshot",
  element: "search input",
  text: "Hello world",
  submit: false
})
```

## Testing Workflow

### Recommended Flow
```typescript
// 1. Navigate to page
browser_navigate({ url: "http://localhost:3000" })

// 2. ALWAYS snapshot to see what's on the page
browser_snapshot()

// 3. Review the snapshot output carefully
//    - Look for the element you want to interact with
//    - Note its ref
//    - Check its current state/value

// 4. Interact using the ref from step 3
browser_click({ ref: "ref-from-snapshot", element: "button description" })

// 5. Wait for changes if needed
browser_wait_for({ time: 1 })

// 6. Snapshot again to verify changes
browser_snapshot()

// 7. Verify expected changes in the new snapshot
//    - Check data-theme attribute changed
//    - Check element visibility
//    - Check text content updated
```

## Common Scenarios

### Scenario: Testing Theme Selector

```typescript
// ❌ WRONG WAY
browser_click({
  ref: '[data-testid="theme-selector"]',
  element: "theme selector"
})
// Error: Invalid selector or can't find element

// ✅ CORRECT WAY
// Step 1: Navigate
browser_navigate({ url: "http://localhost:3000" })

// Step 2: Snapshot to see the page
browser_snapshot()
// Output shows: select element with ref="123" has data-testid="theme-selector"

// Step 3: Interact with correct ref
browser_select_option({
  ref: "123",
  element: "theme selector dropdown",
  values: ["dark"]
})

// Step 4: Verify change
browser_snapshot()
// Check that html element now has data-theme="dark"
```

### Scenario: Clicking a Button

```typescript
// ❌ WRONG WAY
browser_click({
  ref: 'button:hastext("Submit")',
  element: "submit button"
})
// Error: Invalid selector

// ✅ CORRECT WAY
browser_snapshot()
// Find button in snapshot output, get its ref (e.g., "456")

browser_click({
  ref: "456",
  element: "submit button"
})
```

## Debugging Failed Selectors

When you get a selector error:

1. **Check if you ran snapshot first**
   - Did you call `browser_snapshot()` before the interaction?
   - Are you using the ref from that snapshot output?

2. **Verify the element exists**
   - Look at the snapshot output
   - Is the element actually on the page?
   - Is it visible (not hidden by CSS)?

3. **Check for timing issues**
   - Did the page finish loading?
   - Do you need to wait for an animation or state change?
   - Use `browser_wait_for({ time: 1 })` if needed

4. **Verify your selector syntax**
   - Are you using valid CSS selector syntax?
   - Did you avoid invalid pseudo-selectors like `:hastext()`?
   - Are you using actual attributes that exist in your HTML?

5. **Take a screenshot to see the actual page**
   ```typescript
   browser_take_screenshot({ fullPage: true })
   ```

## Anti-Patterns to Avoid

### ❌ Don't Make Up Selectors
```typescript
// WRONG - Assuming attributes exist
ref: '[data-action="submit"]'  // Does this attribute exist?
ref: '[data-component="theme-toggle"]'  // Check your actual HTML
```

### ❌ Don't Use Non-Standard Pseudo-Selectors  
```typescript
// WRONG - These are not valid CSS
ref: 'button:hastext("Click")'
ref: 'div:contains("Hello")'
```

### ❌ Don't Skip Snapshots
```typescript
// WRONG - Trying to interact without seeing the page first
browser_click({ ref: "some-button", element: "button" })
// How do you know what ref to use without a snapshot?
```

### ❌ Don't Ignore Snapshot Output
```typescript
// WRONG - Getting a snapshot but not using the ref from it
browser_snapshot()
// ... then using a made-up selector instead of the ref from snapshot
browser_click({ ref: '[data-testid="btn"]', element: "button" })
```

## Best Practices Summary

1. ✅ **Always snapshot before interacting** - This cannot be stressed enough
2. ✅ **Use refs from snapshot output** - Don't make up selectors
3. ✅ **Use valid CSS selectors only** - No custom pseudo-selectors like `:hastext()`
4. ✅ **Check actual HTML/code** - Verify data attributes exist in your components
5. ✅ **Wait for page loads** - Use `browser_wait_for` when needed
6. ✅ **Verify changes** - Snapshot again after interactions to confirm success
7. ✅ **Take screenshots when debugging** - Visual confirmation helps
8. ✅ **Read error messages carefully** - They tell you exactly what selector failed

## Quick Reference: Valid Data Attributes in This Project

Based on our PRDs and components:

```typescript
// ThemeSelector component
[data-testid="theme-selector"]  // ✅ EXISTS

// Theme toggle (if using old version)
[data-testid="theme-toggle"]    // ✅ EXISTS

// Root element
html[data-theme="light"]         // ✅ EXISTS
html[data-theme="dark"]          // ✅ EXISTS
html[data-theme="purple"]        // ✅ EXISTS
html[data-theme="orange"]        // ✅ EXISTS

// Fake attributes that DON'T exist
[data-cursor-ref="..."]          // ❌ DOESN'T EXIST
[data-action="..."]              // ❌ DOESN'T EXIST (unless you added it)
```

## Example: Complete Test Flow

```typescript
// Testing theme switching from light to dark
async function testThemeSwitching() {
  // 1. Navigate
  await browser_navigate({ url: "http://localhost:3000" });
  
  // 2. Initial snapshot
  const snapshot1 = await browser_snapshot();
  // Review: html has data-theme="light", theme selector shows "light"
  
  // 3. Find the theme selector ref from snapshot
  // Look for: select element with data-testid="theme-selector"
  // Let's say the ref is "theme-select-123"
  
  // 4. Change theme to dark
  await browser_select_option({
    ref: "theme-select-123",  // From snapshot!
    element: "theme selector dropdown",
    values: ["dark"]
  });
  
  // 5. Wait a moment for change to apply
  await browser_wait_for({ time: 0.5 });
  
  // 6. Snapshot again to verify
  const snapshot2 = await browser_snapshot();
  // Verify: html now has data-theme="dark"
  // Verify: page background color changed
  // Verify: text colors changed
  
  // 7. Optional: Take screenshot for visual confirmation
  await browser_take_screenshot({ 
    filename: "dark-theme.png",
    fullPage: true 
  });
  
  console.log("✅ Theme switching test passed!");
}
```

## When Things Go Wrong

### Error: "is not a valid selector"
- **Cause**: Using invalid CSS syntax or pseudo-selectors
- **Fix**: Use `browser_snapshot()` first and get the ref from there

### Error: "Cannot find element"  
- **Cause**: Element doesn't exist or isn't visible yet
- **Fix**: Check snapshot output, wait for page load, verify element exists

### Error: "Permission denied" or similar
- **Cause**: Missing `element` parameter or unclear description
- **Fix**: Add clear `element` description for user permission

### No error but nothing happens
- **Cause**: Clicked wrong element, or change hasn't applied yet
- **Fix**: Verify ref is correct, add wait time, snapshot to confirm

## Conclusion

**The most important rule**: Always run `browser_snapshot()` first and use the refs from its output. Don't try to construct selectors yourself unless you absolutely have to, and when you do, use only valid CSS selector syntax.

Following these practices will make browser automation reliable and error-free.

